rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isSignedIn();
    }
    
    // Categories - Read: Everyone, Write: Admin only
    match /categories/{categoryId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Menu Items - Read: Everyone, Write: Admin only
    match /items/{itemId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Orders - Create: Anyone, Read/Update/Delete: Admin only
    match /orders/{orderId} {
      allow create: if request.resource.data.keys().hasAll(['items', 'total', 'type', 'customer', 'status'])
                    && request.resource.data.items.size() > 0
                    && request.resource.data.total > 0
                    && request.resource.data.status == 'pending';
      allow read, update, delete: if isAdmin();
    }
    
    // Comments/Reviews - Create: Anyone, Read approved: Everyone, Admin: Full access
    match /comments/{commentId} {
      allow create: if request.resource.data.keys().hasAll(['userName', 'rating', 'text'])
                    && request.resource.data.rating >= 1 
                    && request.resource.data.rating <= 5
                    && request.resource.data.approved == false;
      allow read: if resource.data.approved == true || isAdmin();
      allow update, delete: if isAdmin();
    }
    
    // Messages - Create: Anyone, Read/Update/Delete: Admin only
    match /messages/{messageId} {
      allow create: if request.resource.data.keys().hasAll(['name', 'message'])
                    && request.resource.data.read == false;
      allow read, update, delete: if isAdmin();
    }
    
    // Offers - Read: Everyone, Write: Admin only
    match /offers/{offerId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Settings - Read: Everyone, Write: Admin only
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Admin Logs - Admin only
    match /admin_logs/{logId} {
      allow read, write: if isAdmin();
    }
    
    // Jobs - Read active: Everyone, Write: Admin only
    match /jobs/{jobId} {
      allow read: if resource.data.active == true || isAdmin();
      allow create, update, delete: if isAdmin();
    }
    
    // Job Applications - Create: Anyone, Read/Update/Delete: Admin only
    match /jobApplications/{applicationId} {
      allow create: if request.resource.data.keys().hasAll(['jobId', 'jobTitle', 'applicantName', 'applicantPhone', 'message'])
                    && request.resource.data.status == 'new'
                    && request.resource.data.read == false;
      allow read, update, delete: if isAdmin();
    }
  }
}
